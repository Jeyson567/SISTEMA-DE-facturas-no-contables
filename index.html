<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema de Tickets</title>

<style>
	body{
		font-family: monospace;
		background:#f5f5f5;
		padding:20px;
		display:flex;
		flex-direction:column;
		align-items:center;
	}

	.ticket{
		width:80mm;
		background:#fff;
		padding:5mm;
		border:1px solid #ccc;
		box-shadow:0 2px 8px #ccc;
		box-sizing:border-box;
	}

	.ticket-header,
	.ticket-footer{
		text-align:center;
		font-size:13px;
	}

	table{
		width:100%;
		border-collapse:collapse;
		font-size:13px;
	}

	th,td{
		padding:2px 0;
	}

	/* Alineación tipo POS */
	th:nth-child(1), td:nth-child(1){ text-align:left; }
	th:nth-child(2), td:nth-child(2),
	th:nth-child(3), td:nth-child(3),
	th:nth-child(4), td:nth-child(4){ text-align:right; }

	input{ width:100%; }

	.no-print{ margin-bottom:20px; }

	/* IMPRESIÓN 80MM SIN CORTES */
	@page{
		size:80mm auto;
		margin:0;
	}

	@media print{
		html, body{
			width:80mm;
			margin:0;
			padding:0;
			background:none;
		}

		.no-print{ display:none; }

		.ticket{
			width:80mm;
			margin:0;
			padding:5mm;
			border:none;
			box-shadow:none;
			box-sizing:border-box;
		}
	}
</style>
</head>

<body>

<div class="no-print">
	<h2>Generar Ticket</h2>

	<form id="ticketForm">
	<table>
		<thead>
			<tr>
				<th>Descripción</th>
				<th>Cant</th>
				<th>P.Unit</th>
				<th>Subt</th>
				<th></th>
			</tr>
		</thead>
		<tbody id="itemsBody"></tbody>
	</table>

	<button type="button" onclick="addItem()">Agregar ítem</button>

	<div style="text-align:right;margin-top:10px;">
		<b>Total: Q <span id="total">0.00</span></b>
	</div>

	<button type="submit">Generar Ticket</button>
	</form>
</div>

<div id="ticket" class="ticket" style="display:none;"></div>

<div class="no-print" style="text-align:center;margin-top:10px;">
	<button onclick="window.print()">Imprimir</button>
	<button onclick="resetTickets()" style="margin-left:8px;">
		Restablecer conteo
	</button>
</div>

<script>
	/* CONTADOR DE TICKETS */
	if(!localStorage.getItem('ticketNumber')){
		localStorage.setItem('ticketNumber','1');
	}

	function nextTicket(){
		let n=parseInt(localStorage.getItem('ticketNumber'));
		localStorage.setItem('ticketNumber',n+1);
		return n;
	}

	/* ÍTEMS */
	function addItem(){
		const tr=document.createElement('tr');
		tr.innerHTML=`
			<td><input class="desc" required></td>
			<td><input type="number" class="cant" value="1" min="1" style="width:50px"></td>
			<td><input type="number" class="precio" value="0" min="0" step="0.01" style="width:70px"></td>
			<td class="sub">0.00</td>
			<td><button type="button" onclick="this.closest('tr').remove();calc()">X</button></td>
		`;
		document.getElementById('itemsBody').appendChild(tr);
		tr.querySelectorAll('input').forEach(i=>i.oninput=calc);
		calc();
	}

	function calc(){
		let total=0;
		document.querySelectorAll('#itemsBody tr').forEach(tr=>{
			const c=parseFloat(tr.querySelector('.cant').value)||0;
			const p=parseFloat(tr.querySelector('.precio').value)||0;
			const s=c*p;
			tr.querySelector('.sub').textContent=s.toFixed(2);
			total+=s;
		});
		document.getElementById('total').textContent=total.toFixed(2);
		return total;
	}

	/* GENERAR TICKET */
	document.getElementById('ticketForm').onsubmit=e=>{
		e.preventDefault();

		let rows='';
		document.querySelectorAll('#itemsBody tr').forEach(tr=>{
			const d=tr.querySelector('.desc').value;
			const c=tr.querySelector('.cant').value;
			const p=tr.querySelector('.precio').value;
			const s=tr.querySelector('.sub').textContent;
			if(d) rows+=`
				<tr>
					<td>${d}</td>
					<td>${c}</td>
					<td>Q${Number(p).toFixed(2)}</td>
					<td>Q${s}</td>
				</tr>`;
		});

		const now=new Date();
		const total=calc().toFixed(2);

		document.getElementById('ticket').innerHTML=`
			<div class="ticket-header">
				¡Bienvenido!<br>
				Nos alegra recibirle.<br>
				Esperamos que disfrute su estancia y nuestros servicios.
			</div>

			<div style="text-align:center;margin:6px 0;">
				TICKET #${nextTicket()}
			</div>

			<div>Fecha: ${now.toLocaleDateString('es-GT')}</div>
			<div>Hora: ${now.toLocaleTimeString('es-GT')}</div>

			<hr>

			<table>
				<thead>
					<tr>
						<th>Descripción</th>
						<th>Cant</th>
						<th>P.Unit</th>
						<th>Subt</th>
					</tr>
				</thead>
				<tbody>${rows}</tbody>
			</table>

			<hr>

			<div style="text-align:right;font-size:15px;">
				<b>Total: Q${total}</b>
			</div>

			<hr>

			<div class="ticket-footer">
				Fue un placer atenderle.<br>
				Le esperamos pronto para servirle nuevamente.
			</div>
		`;

		document.getElementById('ticket').style.display='block';
		document.getElementById('itemsBody').innerHTML='';
		addItem();
	};

	/* RESTABLECER CONTEO */
	function resetTickets(){
		const pwd = prompt("Ingrese contraseña de administrador:");
		if(pwd === null) return;

		const PASSWORD = "45985365"; // cambia si deseas

		if(pwd === PASSWORD){
			if(confirm("¿Restablecer el conteo de tickets a 1?")){
				localStorage.setItem("ticketNumber","1");
				alert("Conteo restablecido correctamente");
			}
		}else{
			alert("Contraseña incorrecta");
		}
	}

	window.onload=addItem;
</script>

</body>
</html>